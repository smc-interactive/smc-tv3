function updateImages(a){bgImg=$("#carousel-cities .active img"),cuguiImg=$("#carousel-cugui .active img"),stampImg=$("#stamps");var b=["sello-barcelona","sello-vegas","sello-hollywood","sello-chicago","sello-nyc","sello-cuba"];countryStampImg=$("#"+b[cityNames.indexOf(city)]),paperImg=$("#paper-texture"),$("<img/>").attr("src",bgImg.attr("src")).load(function(){bgImg.width=this.width,bgImg.height=this.height,$("<img/>").attr("src",cuguiImg.attr("src")).load(function(){cuguiImg.width=this.width,cuguiImg.height=this.height,$("<img/>").attr("src",paperImg.attr("src")).load(function(){paperImg.width=this.width,paperImg.height=this.height,$("<img/>").attr("src",countryStampImg.attr("src")).load(function(){countryStampImg.width=this.width,countryStampImg.height=this.height,$("<img/>").attr("src",stampImg.attr("src")).load(function(){stampImg.width=this.width,stampImg.height=this.height,a()})})})})})}function doTransform(){function a(a,b,c,d,e,f,g){for(var h=b.split(" "),i="",j=0;j<h.length;j++){var k=i+h[j]+" ",l=a.measureText(k),m=l.width;m>e&&j>0?(g&&a.strokeText(i,c,d),a.fillText(i,c,d),i=h[j]+" ",d+=f):i=k}g&&a.strokeText(i,c,d),a.fillText(i,c,d)}ctx.save(),ctx.clearRect(0,0,canvas.width,canvas.height),ctx.translate(canvas.width/2,canvas.height/2),ctx.translate(-canvas.width/2,-canvas.height/2);var b=200,c=20;(canvas.width-b)/2;updateImages(function(){var d=cityNames.indexOf(city);console.log(cities[d]);var e=canvas.width/2,f=canvas.height/2,g=canvas.height*(bgImg.width/bgImg.height);ctx.drawImage(bgImg[0],0,0,bgImg.width,bgImg.height,0,0,g,canvas.height),ctx.drawImage(cuguiImg[0],0,0,cuguiImg.width,cuguiImg.height,5,canvas.height-200-5,200*(cuguiImg.width/cuguiImg.height),200),ctx.drawImage(paperImg[0],0,0,paperImg.width,paperImg.height,g+10,0,canvas.height*(paperImg.width/paperImg.height),canvas.height),ctx.drawImage(countryStampImg[0],0,0,cuguiImg.width,cuguiImg.height,720,10,250*(cuguiImg.width/cuguiImg.height),250),ctx.drawImage(stampImg[0],0,0,cuguiImg.width,cuguiImg.height,680+20*Math.random(),10+30*Math.random(),250*(cuguiImg.width/cuguiImg.height),250),ctx.restore(),ctx.lineWidth=0,ctx.font='12pt "Architects Daughter", cursive',ctx.strokeStyle="#333",ctx.fillStyle="black",ctx.textAlign="left",ctx.lineJoin="round";var h=$("textarea.form-control").val();h+=" - Amb afecte, Xavier Cugat",e=g+20,f=100,ctx.save(),a(ctx,h,e,f,b,c),ctx.lineWidth=0,ctx.font='9pt "Courier New", Courier, "Lucida Sans Typewriter", "Lucida Typewriter", monospace',ctx.strokeStyle="#999",ctx.fillStyle="black",ctx.textAlign="left",ctx.lineJoin="round";var h=cities[d].place;e=g+20,f=30,b=200,c=15,ctx.save(),a(ctx,h,e,f,b,c);var h="xaviercugat.ccma.cat";e=g+135,f=295,b=600,c=15,ctx.save(),a(ctx,h,e,f,b,c),ctx.lineWidth=7,ctx.font=cities[d].fontStyle,ctx.strokeStyle=cities[d].strokeColor,ctx.fillStyle=cities[d].fillColor,ctx.textAlign="center",ctx.lineJoin="round";var h=cities[d].greeting;cities[d].upperText&&(h=h.toUpperCase()),e=g/2,f=50,b=400,c=25,ctx.save(),a(ctx,h,e,f,b,c,!0)})}function dataURItoBlob(a){var b;b=a.split(",")[0].indexOf("base64")>=0?atob(a.split(",")[1]):unescape(a.split(",")[1]);for(var c=a.split(",")[0].split(":")[1].split(";")[0],d=new Uint8Array(b.length),e=0;e<b.length;e++)d[e]=b.charCodeAt(e);return new Blob([d],{type:c})}function postCanvasToURL(a,b,c){var d=Ladda.create(a);if(d.start(),isGenerated)d.stop(),b(currentImg);else{var f,e=$("#postcardcanvas")[0].toDataURL("image/jpeg",.9);f=e.split(",")[0].indexOf("base64")>=0?atob(e.split(",")[1]):unescape(e.split(",")[1]),e=e.replace("data:image/jpeg;base64,",""),$.ajax({url:"https://55kesmchrh.execute-api.eu-west-1.amazonaws.com/beta/postcards",type:"POST",data:'{"data":"'+e+'"}',dataType:"json",crossDomain:!0,contentType:"application/json"}).done(function(a){currentImg=a.url,isGenerated=!0,b(a.url)}).fail(function(a){c(a)}).always(function(){d.stop()})}}function getMessage(){var a="Acabo d'estar en #"+city.replace(" ","")+" amb #XavierCugatTV3, Quina passada! Viatja tu també en http://xaviercugat.ccma.cat";return console.log(a),a}function sendToTwitter(a){var b=dataURItoBlob(imgRRSS),c=$("#twitterText").text(),d=Ladda.create(a);d.start(),OAuth.popup("twitter").then(function(a){var d=new FormData;return d.append("status",c),d.append("media[]",b,"postcard.png"),a.post("/1.1/statuses/update_with_media.json",{data:d,cache:!1,processData:!1,contentType:!1})}).done(function(a){var b=JSON.stringify(a,null,2);$("#successMsg").show(),console.log("Success (Twitter) "+b)}).fail(function(a){var b=JSON.stringify(a,null,2);console.log("Error (Twitter) "+b),console.log(a),$("#errorMsg").show()}).always(function(){$("#twitterSharing").modal("hide"),d.stop()})}function sendToFacebook(a){var c=(dataURItoBlob(imgRRSS),$("#facebookText").text()),d=Ladda.create(a);d.start(),postCanvasToURL(a,function(a){FB.login(function(){FB.api("/me/photos","POST",{url:a,caption:c},function(a){if(a&&!a.error){var b=JSON.stringify(a,null,2);$("#successMsg").show(),console.log("Success (Facebook) "+b)}else if(a.error){var c=JSON.stringify(a.error,null,2);console.log("Error (Facebook) "+c),$("#errorMsg").show()}$("#facebookSharing").modal("hide"),d.stop()})},{scope:"publish_actions"})},function(a){console.log(a),d.stop(),$("#errorMsg").show()})}function downloadCanvas(a,b,c){console.log("descarga postcard"),a.href=document.getElementById(b).toDataURL(),a.download=c}function countChar(a,b){var c=a.value.length;c>=140?(a.value=a.value.substring(0,140),$(b).text(0)):$(b).text(140-c)}function switchStep(){$("#firstStep").toggle(),$("#secondStep").toggle()}var canvas=document.getElementById("postcardcanvas");ctx=canvas.getContext("2d");var isGenerated=!0,urlInteractivo="http://xaviercugat.ccma.cat",deviceWidth=window.innerWidth;canvasWidth=Math.min(855,deviceWidth-20),canvasHeight=Math.min(300,deviceWidth-20),canvas.width=canvasWidth,canvas.height=canvasHeight,OAuth.initialize("W1QUT8jFolzTPwMYUXENqxkPCl4");var cityNames=["Barcelona","Las Vegas","Los Angeles","Berlin","New York","l'Havana"],city="Barcelona",cities=[{name:"Barcelona",place:"Hotel Ritz, Barcelona, España",greeting:"Recuerdo de Barcelona",fontStyle:'20pt "Diplomata SC", cursive',strokeColor:"white",fillColor:"#d82a11",upperText:1},{name:"Las Vegas",place:"The Flamingo, Las Vegas, NV, USA",greeting:"Welcome to Las Vegas",fontStyle:'28pt "Yesteryear", cursive',strokeColor:"#FFF",fillColor:"#279dda",upperText:0},{name:"Los Angeles",place:"Metro Goldwyn Mayer Studios, Beverly Hills, CA, USA",greeting:"Greetings from Hollywood California",fontStyle:'21pt "Yesteryear", cursive',strokeColor:"white",fillColor:"#dc502b",upperText:0},{name:"Berlin",place:"Akademie Hochschule für Musik, 10178, Berlin, Deutschland",greeting:"Herzliche Grüße aus Berlin",fontStyle:'22pt "Fugaz One", cursive',strokeColor:"white",fillColor:"red",upperText:0},{name:"New York",place:"Carnegie Hall, New York, USA",greeting:"Souvenir from New York",fontStyle:'19pt "Diplomata SC", cursive',strokeColor:"white",fillColor:"red",upperText:0},{name:"La Habana",place:"Teatro Nacional de Cuba, La Habana, República de Cuba",greeting:"Recuerdos de La Habana",fontStyle:'25pt "Yesteryear", cursive',strokeColor:"white",fillColor:"red",upperText:0}],bgImg={},cuguiImg={},paperImg={},countryStampImg={},stampImg={},currentImg="",imgRRSS="";$("#generateButton").click(function(){console.log("generating..."),doTransform(),isGenerated=!1,currentImg="",switchStep()}),$("#editPostcard").click(function(){switchStep()}),$("#sendConfirmationTwitter").click(function(){sendToTwitter(this)}),$("#sendConfirmationFacebook").click(function(){sendToFacebook(this)}),$("#shareTwitter").click(function(){console.log("share on Twitter clicked"),imgRRSS=$("#postcardcanvas")[0].toDataURL();var a=$("#twitterText");$("#twitterPostcard").attr("src",imgRRSS),a.text(getMessage()),countChar(document.getElementById("twitterText"),".charsTwitter"),$("#twitterSharing").modal("show")}),$("#shareFacebook").click(function(){console.log("share on Facebook clicked"),imgRRSS=$("#postcardcanvas")[0].toDataURL();var a=$("#facebookText");$("#facebookPostcard").attr("src",imgRRSS),a.text(getMessage()),countChar(document.getElementById("facebookText"),".charsFacebook"),$("#facebookSharing").modal("show"),FB.getLoginStatus(function(a){"connected"===a.status?console.log("Logged in."):FB.login()})}),$("#carousel-cities .carousel-control").click(function(){setTimeout(function(){city=$("#carousel-cities .active div.carousel-caption").text().trim(),console.log("update city: "+city),console.log("index: "+cityNames.indexOf(city))},1e3)}),document.getElementById("downloadPostcard").addEventListener("click",function(){downloadCanvas(this,"postcardcanvas","xaviercugat-postcard.png")},!1),countChar(document.getElementById("customText")),$(document).ready(function(){$.ajaxSetup({cache:!0}),$.getScript("//connect.facebook.net/en_US/sdk.js",function(){FB.init({appId:"370657399946407",version:"v2.8"})})});
